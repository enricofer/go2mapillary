<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src='https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.js'></script> 

    <link rel="stylesheet" href='https://unpkg.com/mapillary-js@4.1.2/dist/mapillary.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #mly {
          position: fixed;
          width: 100%;
          height: 100%;
          left: 0;
          top: 0;
          background: rgba(51,51,51,0.7);
        }
    </style>
</head>

<body style="margin:0px;">
    <div id='mly'></div>
    <script>
        "use strict";

        var lastMsg = Date.now();
        var addedTagsId = 0;

        var QgisConnection;

        function sendMessage (msg){
            if (Date.now()-lastMsg > 200){
                QgisConnection.JSONmessage(msg);
                lastMsg = Date.now();
            }
        }

        function gup(name)
        {
          name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
          var regexS = "[\\?&]"+name+"=([^&#]*)";
          var regex = new RegExp( regexS );
          var results = regex.exec( window.location.href );
          if( results == null )
            return "";
          else
            return results[1];
        };

        var key_param = parseInt(gup('key'));

        var accessToken = gup('accessToken');

        var {Viewer} = mapillary;

        var mly = new Viewer({ 
            accessToken: accessToken,    
            container: 'mly', 
            //imageId: key_param, 
            });

            mly.on("image", function (event) {
                console.log("EVENT", event)
                // var latLon = [node.latLon.lat, node.latLon.lon];
                // var originalLatLon = [node.originalLatLon.lat, node.originalLatLon.lon];

                // mapNodePosition.line = [node.originalLatLon, node.latLon];
                // mapNodePosition.originalPos = node.originalLatLon;
                // mapNodePosition.pos = node.latLon;

                var viewPar = {
                    "transport":"view",
                    "lat":event.image.latLon.lat,
                    "lon":event.image.latLon.lon,
                    "key":event.image.id,
                    "ca": event.image.compass_angle,
                    "sequence": event.image.sequence
                    //"sequence":node.sequenceKey(),
                    //"originalLat":node.originalLatLon.lat,
                    //"originallon":node.originalLatLon.lon,
                    //"capturedAt":node.capturedAt()
                };
                sendMessage(JSON.stringify(viewPar));

                // var menuContainer = document.getElementById("menu")
                // var sequenceContainer = document.querySelectorAll(".SequenceContainer")
                // menuContainer.classList.remove("hidden");

                // key_param = node.key;
                // mly.currentKey = node.key

                // QgisConnection.restoreTags(key_param)

        })

        function changeImgKey (key){
                key_param = key;
                mly.currentKey = key
                mly.moveTo(key_param).then(
                    function() { /* noop */ },
                    function(e) { console.error(e); });
        }

        new QWebChannel(qt.webChannelTransport, function (channel) {
            QgisConnection = channel.objects.backend;
        });

        changeImgKey(key_param);

    </script>
</body>
</html>

